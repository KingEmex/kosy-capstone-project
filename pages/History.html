<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Search History</title>
<link rel="stylesheet" href="/bootstrap-5.3.8-dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">

<!-- fav-icons -->
<link rel="icon" href="/assets/favicon.ico/favicon.ico" type="image/x-icon">
<style>
body { 
  background-image: url(/assets/image/old-books-arrangement-with-light.jpg); 
  background-size: cover; 
  margin:0; font-family: Arial,sans-serif; 
}
.app-container { max-width:480px; margin:auto; padding:1rem; padding-bottom:80px; }
.card-clickable { 
  cursor:pointer; display:flex; justify-content:space-between; align-items:center; 
  padding:0.5rem 1rem; border-radius:5px; margin-bottom:0.5rem; background:white; 
  box-shadow:0 2px 4px rgba(0,0,0,0.05); 
}
.card-clickable:hover { background:#f1f1f1; }
.top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
.section-title { font-weight:bold; margin-top:1rem; margin-bottom:0.5rem; color:#007bff; }
.word-container { margin-bottom:0.5rem; }
.word-card { background:#f8f9fa; padding:10px; border-radius:8px; margin-top:5px; display:none; }
.btn-group { margin-top:5px; }
.bottom-navbar { position: fixed; bottom:0; width:100%; height:60px; background: black; box-shadow:0 -2px 5px rgba(0,0,0,0.1); display:flex; justify-content:space-around; align-items:center; }
.bottom-navbar .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; cursor:pointer; font-size:0.8rem; }
.bottom-navbar .nav-item.active { color:#007bff; }
.bottom-navbar .nav-item i { font-size:1.5rem; }
</style>
</head>
<body>

<div class="app-container">
  <div class="top-bar">
    <h2 class="text-primary"><i class="bi bi-clock-history"></i> History</h2>
    <button id="clearHistoryBtn" class="btn btn-outline-danger"><i class="bi bi-trash"></i></button>
  </div>

  <div id="historySection">
    <div class="section-title">Recent Searches</div>
    <div id="historyCards"></div>
  </div>
</div>

<!-- Bottom Navbar -->
<nav class="bottom-navbar">
  <div id="navHome" class="nav-item"><i class="bi bi-house"></i><div>Home</div></div>
  <div id="navHistory" class="nav-item active"><i class="bi bi-clock-history"></i><div>History</div></div>
</nav>

<script>
let history = JSON.parse(localStorage.getItem("searchHistory")) || [];

const historyCards = document.getElementById("historyCards");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");

let isReading = false;

// --- Render history cards ---
function renderHistoryCards(){
  historyCards.innerHTML="";
  if(history.length===0){
    historyCards.innerHTML=`<div class="alert alert-secondary">No history available.</div>`;
    return;
  }
  history.forEach(word => {
    const container = document.createElement("div");
    container.className="word-container";
    container.innerHTML = `<div class="card-clickable">${word}</div><div class="word-card" id="card-${word}"></div>`;
    const clickable = container.querySelector(".card-clickable");
    const card = container.querySelector(".word-card");

    clickable.addEventListener("click", ()=> toggleDefinition(word, card));

    historyCards.appendChild(container);
  });
}

// --- Fetch & toggle definition ---
function toggleDefinition(word, container){
  if(container.style.display==="block"){
    container.style.display="none";
    speechSynthesis.cancel();
    isReading=false;
    return;
  }
  if(container.innerHTML===""){
    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`)
      .then(res=>res.json())
      .then(data=>{
        if(data.title && data.message){ 
          container.innerHTML=`<div class="alert alert-danger">${data.message}</div>`; 
        } else displayWord(data[0], container, word);
        container.style.display="block";
      }).catch(err=>{
        container.innerHTML=`<div class="alert alert-warning">‚ö†Ô∏è ${err.message}</div>`; 
        container.style.display="block";
      });
  } else {
    container.style.display="block";
  }
}

// --- Display word card ---
function displayWord(data, container, word){
  container.innerHTML=`
    <div>
      <p><strong>Phonetics:</strong> ${data.phonetic||"N/A"}</p>
      ${data.meanings.map(m=>`<div><strong>${m.partOfSpeech}</strong>${m.definitions.map(d=>`<p><strong>Definition:</strong> ${d.definition}</p>${d.example?`<p><em>Example: ${d.example}</em></p>`:""}`).join("")}</div>`).join("")}
      <div class="btn-group gap-2">
        <button class="btn btn-sm btn-secondary btn-read">üîä Read</button>
        <button class="btn btn-sm btn-danger btn-reset">‚úñ Remove</button>
      </div>
    </div>
  `;
  const readBtn = container.querySelector(".btn-read");
  const resetBtn = container.querySelector(".btn-reset");

  readBtn.addEventListener("click", ()=>{
    if(isReading){
      speechSynthesis.cancel();
      isReading=false;
      readBtn.textContent="üîä Read";
      return;
    }
    let chunks = [];
    if(data.word) chunks.push({text:"Word: "+data.word, pause:600});
    if(data.phonetic) chunks.push({text:"Phonetic: "+data.phonetic, pause:400});
    data.meanings.forEach(m=>{
      chunks.push({text:m.partOfSpeech, pause:400});
      m.definitions.forEach(d=>{
        chunks.push({text:"Definition: "+d.definition, pause:400});
        if(d.example) chunks.push({text:"Example: "+d.example, pause:400});
      });
    });
    let index=0;
    isReading=true;
    readBtn.textContent="‚èπ Stop";
    function speakNext(){
      if(!isReading || index>=chunks.length){
        isReading=false;
        readBtn.textContent="üîä Read";
        return;
      }
      const utter = new SpeechSynthesisUtterance(chunks[index].text);
      utter.lang="en-US";
      utter.rate=1;
      utter.pitch=1;
      utter.onend = ()=>{ index++; setTimeout(speakNext,chunks[index-1].pause); };
      speechSynthesis.speak(utter);
    }
    speakNext();
  });

  resetBtn.addEventListener("click", ()=>{
    speechSynthesis.cancel();
    isReading=false;
    let h = JSON.parse(localStorage.getItem("searchHistory")) || [];
    const idx = h.indexOf(word);
    if(idx>-1){
      h.splice(idx,1);
      localStorage.setItem("searchHistory", JSON.stringify(h));
    }
    container.parentElement.remove();
  });
}

// --- Clear all history ---
clearHistoryBtn.addEventListener("click", ()=>{
  localStorage.removeItem("searchHistory");
  history=[];
  renderHistoryCards();
});

// --- Initial render ---
renderHistoryCards();

// --- Bottom nav ---
document.getElementById("navHome").addEventListener("click", ()=> window.location.href="search.html");
document.getElementById("navHistory").addEventListener("click", ()=>{});
</script>

</body>
</html>